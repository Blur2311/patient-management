name: Deploy Microservices to AWS

on:
  push:
    branches:
      - main
  # Đề xuất: Thêm trigger cho Pull Request
    pull_request:
      branches:
       - main

env:
  AWS_REGION: ap-southeast-1
  ECR_REPOSITORY_PREFIX: patient-management # Đây là tên repository chung

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_IAM_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build Java Project with Maven
        run: mvn clean package -DskipTests

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag, and Push Docker Images
        id: build-images
        run: |
          # Danh sách các microservice, tương ứng với tên thư mục và 'imageName' trong CDK
          services=("api-gateway" "appointment-service" "auth-service" "billing-service" "patient-service" "analytics-service")
          REGISTRY=${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG=${{ github.sha }}
          
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "ECR_REPO_URI_PREFIX=${REGISTRY}/${ECR_REPOSITORY_PREFIX}" >> $GITHUB_ENV

          # 1. Đảm bảo repository CHUNG tồn tại
          echo "Ensuring ECR repository '${{ env.ECR_REPOSITORY_PREFIX }}' exists..."
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY_PREFIX }} --region ${{ env.AWS_REGION }} --image-scanning-configuration scanOnPush=true || true
          
          # 2. Build và push từng image vào repository chung đó
          for service in "${services[@]}"; do
            echo "Building and pushing image for ${service}..."
            # Tên image được build theo định dạng: <registry>/<repo_chung>/<ten_service>:<tag>
            # Điều này sẽ khớp với logic trong code CDK của bạn
            FULL_IMAGE_NAME="${REGISTRY}/${ECR_REPOSITORY_PREFIX}/${service}:${IMAGE_TAG}"
          
            docker build -t ${FULL_IMAGE_NAME} ./${service}
            docker push ${FULL_IMAGE_NAME}
          done

      - name: Setup Node.js for AWS CDK
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Nên dùng phiên bản Node LTS mới hơn
          cache: 'npm' # Đề xuất: Cache npm packages
          cache-dependency-path: 'infrastructure/package-lock.json'


      - name: Install AWS CDK and dependencies
        run: |
          cd infrastructure
          npm install -g aws-cdk
          npm install

      - name: Deploy CloudFormation Stack with CDK
        run: |
          cd infrastructure
          # Các tham số truyền vào giờ đã khớp với logic build image
          cdk deploy "PatientManagementStack" \
            --require-approval never \
            --parameters EcrRepoUriPrefix=${{ env.ECR_REPO_URI_PREFIX }} \
            --parameters ImageTag=${{ env.IMAGE_TAG }}
